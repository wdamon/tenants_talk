{% load staticfiles %}
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="Add data to the debate, report your eviction">
    <meta name="author" content="William Damon">
    <! <link rel="icon" href="{% static 'favicon.ico' %}">
    <link rel="stylesheet"  href="{% static 'bootstrap.min.css' %}">
    <link rel="stylesheet"  href="{% static 'jumbotron-narrow.css' %}">
    <link href="https://fonts.googleapis.com/css?family=BioRhyme|Rubik+One" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.0-rc.3/dist/leaflet.css" />
    <link rel="stylesheet" href="{% static 'leaflet.markercluster/dist/MarkerCluster.css' %}" />
    <link rel="stylesheet" href="{% static 'leaflet.markercluster/dist/MarkerCluster.Default.css' %}" />
    <link rel="stylesheet" href="{% static 'leaflet-fusesearch-master/src/leaflet.fusesearch.css' %}">
    <script src="https://unpkg.com/leaflet@1.0.0-rc.3/dist/leaflet.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script type="text/javascript" src="{% static 'leaflet-ajax/dist/leaflet.ajax.min.js' %}"></script>
    <script src="{% static 'spin.min.js' %}"></script>
    <script src="{% static 'leaflet-spin/leaflet.spin.js' %}"></script>
    <script src="{% static 'leaflet.markercluster/dist/leaflet.markercluster-src.js' %}"></script>
    <script src="{% static 'fuse.js/src/fuse.js' %}"></script>
    <script src="{% static 'leaflet-fusesearch-master/src/leaflet.fusesearch.js' %}"></script>
    <link rel="stylesheet" href="http://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css"/>
    <link rel="stylesheet" href="{% static 'leaflet.awesome-markers.css' %}" />
    <script src="{% static 'leaflet.awesome-markers.js' %}"></script>
    <script src="https://use.fontawesome.com/2c3856b3e5.js"></script>



    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <link href="{% static 'ie10-viewport-bug-workaround.css' %}" rel="stylesheet">

    <title> Eviction Prevention | Map</title>
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

  </head>
  <body>

    <div class="container">
      <div class="header clearfix">
        <nav style="background-color: black" class="navbar navbar-inverse">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#myNavbar">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <h3 style="color: white">Tenant's Say</h3>
            </div>

            <div class="collapse navbar-collapse" id="myNavbar">
                <ul class="nav nav-pills pull-right">
                    <input type="hidden" id="selected_menu_item" value="=$selectedMenuId; ?>" />
                    <li role="presentation" ><a href="{% url 'index' %}">Report Your Tenancy Issue</a></li>
                    <li role="presentation" class="active"><a href="{% url 'map' %}">Evictions* Map</a></li>
                    <li role="presentation"><a href="/contest">Resedential Tenancy Bot</a></li>
                </ul>
          </div>
      </nav>
    </div>
  </div>
      <div class="container">
        <div class="jumbotron">
          <h1>Mapping Evictions</h1>
            <div class="row">
            <div id="mapid" style="height:80%">
              <script>
              var m  = L.map('mapid').setView([49.251624, -123.081344], 11);
              var mopt = {
                  url:'https://api.tiles.mapbox.com/v4/wdamon.1c70m0jc/{z}/{x}/{y}.png?access_token=pk.eyJ1Ijoid2RhbW9uIiwiYSI6InFVV1VLMFUifQ.2Zx0T9w01EK6E-v76-z85Q',
                  options: {attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://mapbox.com">Mapbox</a>'}
                };
              var mq=L.tileLayer(mopt.url,mopt.options);

              mq.addTo(m);
              function onEachFeature(feature, layer) {
                  if (feature.properties && feature.properties.evictreason) {
                    if (feature.properties.category === 'EVC') {
                      layer.bindPopup("Category: Eviction<br>Address: "+ feature.properties.address +"<br>Description: " +feature.properties.evictreason);
                    } else if (feature.properties.category === 'SEC') {
                      layer.bindPopup("Category: Security Deposit<br>Address: "+ feature.properties.address +"<br>Description: " +feature.properties.evictreason);
                    } else if (feature.properties.category === 'REP') {
                      layer.bindPopup("Category: Repairs<br>Address: "+ feature.properties.address +"<br>Description: " +feature.properties.evictreason);
                    } else if (feature.properties.category === 'OTH') {
                      layer.bindPopup("Category: Other<br>Address: "+ feature.properties.address +"<br>Description: " +feature.properties.evictreason);
                    }
                    feature.layer = layer;
                  }
                };
              var geojsonPointLayer = {{ evc_serialized|safe }};
              var evcIcon = L.AwesomeMarkers.icon({
                  icon: 'home',
                  prefix: 'fa',
                  markerColor: 'red',
                  iconColor: 'white'
                });
              var secIcon = L.AwesomeMarkers.icon({
                    icon: 'usd',
                    prefix: 'fa',
                    markerColor: 'white',
                    iconColor: 'green'
                });
              var repIcon = L.AwesomeMarkers.icon({
                    icon: 'hammer',
                    prefix: 'ion',
                    markerColor: 'black',
                    iconColor: 'white'
                });
              var othIcon = L.AwesomeMarkers.icon({
                    icon: 'question-circle-o',
                    prefix: 'fa',
                    markerColor: 'blue',
                    iconColor: 'white'
                });

              function getMarker(f) {
                if (f === 'EVC') {
                    return {icon: evcIcon}
                } else if (f === 'SEC') {
                    return {icon: secIcon}
                } else if (f === 'REP') {
                    return {icon: repIcon}
                } else
                    return {icon: othIcon}
                }
              var evictions = [];
              var repairs = [];
              var security = [];
              var other = [];

              L.geoJson(geojsonPointLayer, {
                onEachFeature: onEachFeature,
                pointToLayer: function(feature, latlng) {
                  if (feature.properties.category === "EVC") {
                    evictions.push(L.marker(latlng, getMarker(feature.properties.category)))
                  }  else if (feature.properties.category === "REP") {
                    repairs.push(L.marker(latlng, getMarker(feature.properties.category)))
                  } else if (feature.properties.category === "SEC") {
                    security.push(L.marker(latlng, getMarker(feature.properties.category)))
                  } else if (feature.properties.category === "OTH") {
                    other.push(L.marker(latlng, getMarker(feature.properties.category)))
                  }
              }
              });
              var evcGroup = L.layerGroup(evictions);
              var repGroup = L.layerGroup(repairs);
              var secGroup = L.layerGroup(security);
              var othGroup = L.layerGroup(other);

              var baseMaps = {
                "Basemap": mq
              };

              var overlayMaps = {
                "Evictions" : evcGroup,
                "Repairs": repGroup,
                "Security Deposits": secGroup,
                "Other": othGroup
              };
              m.addLayer(evcGroup);
              m.addLayer(repGroup);
              m.addLayer(secGroup);
              m.addLayer(othGroup);
              L.control.layers(baseMaps, overlayMaps, {hideSingleBase: 'true', position: 'bottomright'}).addTo(m);
              var searchCtrl = L.control.fuseSearch();
              searchCtrl.addTo(m);
              searchCtrl.indexFeatures(geojsonPointLayer, ['address', 'evictreason']);
              feature.layer = geojsonPointLayer;


              </script>

            </div>
          </div>

</div>
      </div>

      <footer class="footer">
        <p>&copy; <a href="www.wgdamon.com">William Damon</a> 2016</p>
      </footer>

    </div> <!-- /container -->


    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="{% static 'ie10-viewport-bug-workaround.js' %}"></script>
  </body>
</html>
